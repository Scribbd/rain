Description: |
  Creates a web application with a static website using S3 and CloudFront, 
  an API Gateway REST API, and a DynamoDB table, with Cognito authentication.
  This sample uses Rain Metadata commands to upload content to the static 
  site bucket, and uses a Run property on the S3 directive to build the 
  lambda function, which for this example is written in Go.
  Apache-2.0 License. Adapt this template to your needs and thoruoughly test
  it before introducing it in a production environment. **WARNING** This
  template will create resources in your account that may incur billing
  charges.

Parameters:

  AppName:
    Type: String
    Description: This name is used as a prefix for resource names
    Default: rain-webapp

  UserPoolArn:
    Type: String
    Description: TODO - replace with a UserPool in this template after testing
    Default: arn:aws:cognito-idp:us-east-1:755952356119:userpool/us-east-1_OkBy88ce5

Resources:


  Site:
    Type: !Rain::Module "../modules/static-site.yaml"
    Properties:
      AppName: !Ref AppName
      Content: site/dist
      Run: buildsite.sh

  RestApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Ref AppName

  RestApiDeployment:
    Type: AWS::ApiGateway::Deployment
    Properties:
      RestApiId: !Ref RestApi
    DependsOn:
      - TestResourceProxy 

  RestApiStage:
    Type: AWS::ApiGateway::Stage
    Properties:
      RestApiId: !Ref RestApi
      DeploymentId: !Ref RestApiDeployment
      StageName: prod

  TestResource:
    Type: !Rain::Module "../modules/api-resource.yaml"
    Metadata:
      Comment: This module handles all methods on the /test path on the API. The lambda function code is located in api/resources/test.  
    Properties:
      Name: !Ref AppName
      RestApi: !Ref RestApi
      RestApiDeployment: !Ref RestApiDeployment
      BuildScript: ../webapp/buildapi.sh
      CodePath: ../webapp/api/dist/test/lambda-handler.zip
      ResourcePath: test
      StageName: staging
      AuthProvider: !Ref UserPoolArn
    Overrides:
      Handler:
        Properties:
          Environment:
            Variables:
              TABLE_NAME: !Ref TestTable

  TestResourceHandlerPolicy:
    Type: AWS::IAM::RolePolicy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - dynamodb:BatchGetItem
              - dynamodb:GetItem
              - dynamodb:Query
              - dynamodb:Scan
              - dynamodb:BatchWriteItem
              - dynamodb:PutItem
              - dynamodb:UpdateItem
            Effect: Allow
            Resource: 
              - !GetAtt TestTable.Arn
      PolicyName: handler-policy
      RoleName: !Ref TestResourceHandlerRole

  TestTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      TableName: !Sub ${AppName}-test
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH


Outputs:

  SiteURL:
    Value: !Sub "https://${SiteDistribution.DomainName}"

  RestApiInvokeURL:
    Value: !Sub https://${RestApi}.execute-api.${AWS::Region}.amazonaws.com/${RestApiStage}

